!function(e,t,s,i){function n(t,s){this.element=t,this.options=e.extend({},o,s),this._defaults=o,this._name=a,this.instance,this.callbackManager=new Array,this.elem_isVisible="",this.init()}var a="heapbox",o={effect:{type:"slide",speed:"slow"},insert:"before",heapsize:i,emptyMessage:"Empty",tabindex:"undefined",title:i,showFirst:!0,inheritVisibility:!0,escapeHtml:!0,placeHolder:i,openStart:function(){},openComplete:function(){},closeStart:function(){},closeComplete:function(){},onChange:function(){}};n.prototype={init:function(){this._hideSourceElement(),this._isSourceSelectbox(),this.instance=this.createInstance(),this._createElements(),this._setDefaultValues(),this.userSelectedOption=!1},createInstance:function(){return{heapId:e(this.element).attr("id")||Math.round(99999999*Math.random()),state:!1}},_setEvents:function(){var t=this;this._setControlsEvents(),e(s).on("click","html",function(e){e.stopPropagation(),t._closeheap(!0,function(){},function(){})})},_setSliderEvents:function(){var t=this;this.scrollingStatus=!1,heap=e("#heapbox_"+this.instance.heapId+" .heap"),heap.find(".sliderDown").click(function(e){e.preventDefault(),e.stopPropagation(),t._setHeapboxFocus()}),heap.find(".sliderDown").mousedown(function(s){t.scrollingStatus=!0,t._keyArrowHandler(e("#heapbox_"+t.instance.heapId),"down"),t.interval=setInterval(function(){t._keyArrowHandler(e("#heapbox_"+t.instance.heapId),"down")},300)}).mouseup(function(e){clearInterval(t.interval),t.scrollingStatus=!1}).mouseout(function(e){clearInterval(t.interval),t.scrollingStatus=!1}),heap.find(".sliderUp").click(function(e){e.preventDefault(),e.stopPropagation(),t._setHeapboxFocus()}),heap.find(".sliderUp").mousedown(function(s){t.scrollingStatus=!0,t._keyArrowHandler(e("#heapbox_"+t.instance.heapId),"up"),t.interval=setInterval(function(){t._keyArrowHandler(e("#heapbox_"+t.instance.heapId),"up")},300)}).mouseup(function(e){clearInterval(t.interval),t.scrollingStatus=!1}).mouseout(function(e){clearInterval(t.interval),t.scrollingStatus=!1})},_setViewPosition:function(t){heap=e("div#heapbox_"+this.instance.heapId+" .heap"),heap.show();selected=t.find(".heapOptions li a.selected"),firstTop=t.find(".heapOptions li a").first().offset().top,actTop=e(selected).offset().top,newTop=firstTop-actTop+this.sliderUpHeight,heapHeight=e("div#heapbox_"+this.instance.heapId+" .heapOptions").height(),maxPosition=heapHeight-parseInt(this.options.heapsize,10)+this.sliderDownHeight,minPosition=0+this.sliderUpHeight,-1*newTop>maxPosition&&(newTop=-1*maxPosition),t.find(".heapOptions").css("top",newTop),this.instance.state||heap.hide()},_setKeyboardEvents:function(){var t=this;heapbox=e("#heapbox_"+this.instance.heapId),heapbox.keydown(function(s){switch(s.which){case 13:return t._handlerClicked(),!1;case 27:t._closeheap();break;case 37:t._keyArrowHandler(e("#heapbox_"+t.instance.heapId),"up"),s.preventDefault();break;case 39:t._keyArrowHandler(e("#heapbox_"+t.instance.heapId),"down"),s.preventDefault();break;case 38:t._keyArrowHandler(e("#heapbox_"+t.instance.heapId),"up"),s.preventDefault();break;case 40:t._keyArrowHandler(e("#heapbox_"+t.instance.heapId),"down"),s.preventDefault()}})},_setMouseWheelEvents:function(){var t=e("div#heapbox_"+this.instance.heapId+" .handler"),s=t.find("div.heap");t.on("mousewheel",function(e,t){e.preventDefault(),-1==t?s.find(".sliderDown").mousedown().mouseup():s.find(".sliderUp").mousedown().mouseup()})},_keyArrowHandler:function(t,s){var i=this,n=!1;t.find("div.heap ul li").each(function(){return e(this).find("a").hasClass("selected")&&(n=!0,selectItem="down"==s?i._findNext(e(this)):i._findPrev(e(this)),selectItem)?(i._heapChanged(i,selectItem,!0),!1):void 0}),0==n&&(selectItem=e("div#heapbox_"+i.instance.heapId+" .heapOptions .heapOption").first().find("a").addClass("selected"),i._heapChanged(i,selectItem,!0)),i._setViewPosition(e("#heapbox_"+i.instance.heapId))},_setMouseWheelEvents:function(){var t=e("div#heapbox_"+this.instance.heapId),s=t.find("div.heap");t.on("mousewheel",function(e,t){e.preventDefault(),-1==t?s.find(".sliderDown").mousedown().mouseup():s.find(".sliderUp").mousedown().mouseup()})},_findPrev:function(e){return e.prev().length>0?e.prev().find("a").hasClass("disabled")?this._findPrev(e.prev()):e.prev().find("a"):void 0},_findNext:function(e){return e.next().length>0?e.next().find("a").hasClass("disabled")?this._findNext(e.next()):e.next().find("a"):void 0},_createElements:function(){var t=this;heapBoxEl=e("<div/>",{id:"heapbox_"+this.instance.heapId,"class":"heapBox",data:{sourceElement:this.element}}),1==t.options.inheritVisibility&&0==t.elem_isVisible&&heapBoxEl.css("display","none"),heapBoxHolderEl=e("<a/>",{href:"","class":"holder"}),heapBoxHandlerEl=e("<a/>",{href:"","class":"handler"}),heapBoxheapEl=e("<div/>",{"class":"heap"}),heapBoxEl.append(heapBoxHolderEl),heapBoxEl.append(heapBoxHandlerEl),heapBoxEl.append(heapBoxheapEl),this.heapBoxEl=heapBoxEl,this._insertHeapbox(this.heapBoxEl)},_insertHeapbox:function(t){switch(this.isSourceElementSelect&&"inside"==this.options.insert&&(this.options.insert="before"),this.options.insert){case"before":e(this.element).before(t);break;case"after":e(this.element).after(t);break;case"inside":e(this.element).html(t),this._showSourceElement();break;default:e(this.element).before(t)}},_setDefaultValues:function(){this._initHeap(),this._initView(heapBoxEl),this._setHolderTitle(),this._setTabindex(),this._setEvents(),this._handleFirst()},_setHeapboxFocus:function(){heapbox=e("div#heapbox_"+this.instance.heapId+" .handler"),heapbox.focus()},_setHeapSize:function(){if(this.options.heapsize){if(heapBoxheapEl.height()<parseInt(this.options.heapsize,10))return void delete this.options.heapsize;heapBoxheapEl.css("height",this.options.heapsize)}},_initHeap:function(){var e;this.isSourceElementSelect&&(e=this._optionsToJson(),this._setData(e))},_initView:function(e){this._isHeapEmpty()||this._setViewPosition(e)},_handleFirst:function(){this.options.showFirst||e("div#heapbox_"+this.instance.heapId+" .heapOptions .heapOption").first().remove()},_setHolderTitle:function(){var t=this;holderEl=e("#heapbox_"+this.instance.heapId).find(".holder"),selectedEl=e("#heapbox_"+this.instance.heapId).find(".heap ul li a.selected").last(),this.userSelectedOption&&holderEl.attr("data-user-selected",selectedEl.attr("rel")),0!=selectedEl.length?(this.options.placeHolder&&!this.userSelectedOption?holderEl.html(this.options.placeHolder):this.options.title?holderEl.text(this.options.title):holderEl.text(selectedEl.text()),holderEl.attr("rel",selectedEl.attr("rel")),selectedEl.attr("data-icon-src")&&(iconEl=this._createIconElement(selectedEl.attr("data-icon-src")),holderEl.append(iconEl))):(this.options.placeHolder?t.options.escapeHtml?holderEl.text(this.options.placeHolder):holderEl.html(this.options.placeHolder):t.options.escapeHtml?holderEl.text(this.options.emptyMessage):holderEl.html(this.options.emptyMessage),this._removeHeapboxHolderEvents(),this._removeHeapboxHandlerEvents())},_setTabindex:function(){var t;t="undefined"!=this.options.tabindex?this.options.tabindex:e(this.element).attr("tabindex"),"undefined"!=t&&e("#heapbox_"+this.instance.heapId).attr("tabindex",t)},_setData:function(t){var s=this,i=[],n=jQuery.type(t);if("array"===n)i=t;else{if("string"!==n)throw new Error("_setData(data): data must be array or string");try{i=jQuery.parseJSON(t)}catch(a){console.error("JSON parsing error: ",a)}}var o=!1;heapBoxheapOptionsEl=e("<ul/>",{"class":"heapOptions"}),e.each(i,function(){this.selected&&(o=!0),heapBoxOptionLiEl=e("<li/>",{"class":"heapOption"}),heapBoxheapOptionAEl=e("<a/>",{href:"",rel:this.value,title:this.text,text:this.text,"class":this.selected?"selected":"",click:function(e){e.preventDefault(),e.stopPropagation(),s._heapChanged(s,this)}}),this.disabled&&(heapBoxheapOptionAEl.unbind("click"),heapBoxheapOptionAEl.addClass("disabled"),heapBoxheapOptionAEl.click(function(e){e.preventDefault(),e.stopPropagation()})),this.icon&&(heapBoxheapOptionAEl.attr("data-icon-src",this.icon),heapBoxOptionIcon=s._createIconElement(this.icon),heapBoxheapOptionAEl.append(heapBoxOptionIcon)),heapBoxOptionLiEl.append(heapBoxheapOptionAEl),heapBoxheapOptionsEl.append(heapBoxOptionLiEl)}),e("div#heapbox_"+this.instance.heapId+" .heap ul").remove(),e("div#heapbox_"+this.instance.heapId+" .heap").append(heapBoxheapOptionsEl),this._setHeapSize(),this._isHeapsizeSet()&&(this._createSliderUpElement(),this._createSliderDownElement()),1!=o&&e("div#heapbox_"+this.instance.heapId+" .heap ul li a").first().addClass("selected")},_createSliderUpElement:function(){slideUp=e("<a/>",{"class":"sliderUp",href:""}),e("div#heapbox_"+this.instance.heapId+" .heap .heapOptions").before(slideUp),sliderUp=e("#heapbox_"+this.instance.heapId+" .sliderUp"),this.sliderUpHeight=parseInt(sliderUp.css("height"),10)+parseInt(sliderUp.css("border-top-width"),10)+parseInt(sliderUp.css("border-bottom-width"),10),e("#heapbox_"+this.instance.heapId+" .heapOptions").css("top",this.sliderUpHeight)},_createSliderDownElement:function(){slideDown=e("<a/>",{"class":"sliderDown",href:""}),e("div#heapbox_"+this.instance.heapId+" .heap .heapOptions").after(slideDown),sliderDown=e("#heapbox_"+this.instance.heapId+" .sliderDown"),this.sliderDownHeight=parseInt(sliderDown.css("height"),10)+parseInt(sliderDown.css("border-top-width"))+parseInt(sliderDown.css("border-bottom-width"))},_createIconElement:function(t){return heapBoxOptionIcon=e("<img/>",{src:t,alt:t}),heapBoxOptionIcon},_optionsToJson:function(){var t=[];e(this.element).find("option").each(function(){t.push({value:e(this).attr("value"),text:e(this).text(),icon:e(this).attr("data-icon-src"),disabled:e(this).attr("disabled"),selected:e(this).is(":selected")?"selected":""})});var s=JSON.stringify(t);return s},_heapboxToJson:function(){var t=[];e("div#heapbox_"+this.instance.heapId+" .heap ul li a").each(function(){t.push({value:e(this).attr("rel"),text:e(this).text(),selected:e(this).is(":selected")?"selected":""})});var s=JSON.stringify(t);return s},_isHeapEmpty:function(){var t=e("div#heapbox_"+this.instance.heapId+" .heap ul li").length;return 0==t},_setControlsEvents:function(){this._isHeapEmpty()||(this._setHeapboxHolderEvents(),this._setHeapboxHandlerEvents(),this._setKeyboardEvents(),this._setSliderEvents(),"object"==typeof e.event.special.mousewheel&&this._setMouseWheelEvents())},_isSourceSelectbox:function(){this.isSourceElementSelect=e(this.element).is("select")},_isHeapsizeSet:function(){return this.options.heapsize?!0:!1},_refreshSourceSelectbox:function(t){var s=this,i=!1;e(this.element).find("option").remove(),e.each(t,function(){option=e("<option/>",{value:this.value,text:this.text}),this.selected&&(option.attr("selected","selected"),i=!0),e(s.element).append(option)}),1!=i&&e(s.element).find("option").first().attr("selected","selected")},_setSelectedOption:function(t){this._deselectSelectedOptions(),e(this.element).val(t),e(this.element).find("option[value='"+t+"']").attr("selected","selected")},_deselectSelectedOptions:function(){select=e(this.element).find("option"),select.each(function(){e(this).removeAttr("selected")})},_setHeapboxHolderEvents:function(){var t=this;heapBoxEl=e("div#heapbox_"+this.instance.heapId),heapBoxEl.find(".holder").click(function(e){e.preventDefault(),e.stopPropagation(),t._setHeapboxFocus(),t._handlerClicked()})},_setHeapboxHandlerEvents:function(){var t=this;heapBoxEl=e("div#heapbox_"+this.instance.heapId),heapBoxEl.find(".handler").click(function(e){e.preventDefault(),e.stopPropagation(),t._setHeapboxFocus(),t._handlerClicked()})},_removeHeapboxHolderEvents:function(){heapBoxEl=e("div#heapbox_"+this.instance.heapId),heapBoxEl.find(".holder").unbind("click"),heapBoxEl.find(".holder").click(function(e){e.preventDefault()}),heapBoxEl.unbind("keydown")},_removeHeapboxHandlerEvents:function(){heapBoxEl=e("div#heapbox_"+this.instance.heapId),heapBoxEl.find(".handler").unbind("click"),heapBoxEl.find(".handler").click(function(e){e.preventDefault()})},_handlerClicked:function(e){this.instance.state?this._closeheap():e?this._openheap():this._closeOthers()},_heapChanged:function(t,s,i){i||this._closeheap(!0,function(){},function(){}),this.userSelectedOption=!0,this._setSelected(e(s)),this._setHolderTitle(),this._setHeapboxFocus(),this._setSelectedOption(e(s).attr("rel")),this.options.onChange(e(s).attr("rel"),e(this.element))},_setSelected:function(e){this._deselectAll(),e.addClass("selected")},_deselectAll:function(t){heapLinks=e("#heapbox_"+this.instance.heapId).find(".heap ul li a"),heapLinks.each(function(){e(this).removeClass("selected")})},_closeheap:function(t,s,i){if(heapEl=e("#heapbox_"+this.instance.heapId).removeClass("open").find(".heap"),heapEl.is(":animated")&&!t)return!1;switch(this.instance.state=!1,t?(s=s,i=i):(s=this.options.closeStart,i=this.options.closeComplete),s.call(),this.options.effect.type){case"fade":heapEl.fadeOut(this.options.effect.speed,i);break;case"slide":heapEl.slideUp(this.options.effect.speed,i);break;case"standard":heapEl.css("display","none"),i.call();break;default:heapEl.slideUp(this.options.effect.speed,i)}},_openheap:function(){if(this._isHeapsizeSet()&&this._setViewPosition(e("div#heapbox_"+this.instance.heapId)),heapEl=e("#heapbox_"+this.instance.heapId).addClass("open").find(".heap"),heapEl.is(":animated"))return!1;switch(this.instance.state=!0,this.options.openStart.call(),this.options.effect.type){case"fade":heapEl.fadeIn(this.options.effect.speed,this.options.openComplete);break;case"slide":heapEl.slideDown(this.options.effect.speed,this.options.openComplete);break;case"standard":heapEl.css("display","block"),this.options.openComplete.call();break;default:heapEl.slideDown(this.options.effect.speed,this.options.openComplete)}},_closeOthers:function(){var t=this;e("div[id^=heapbox_]").each(function(s){el=e("div#"+e(this).attr("id")),el.data("sourceElement")&&(sourceEl=e.data(this,"sourceElement"),heapBoxInst=e.data(sourceEl,"plugin_"+a),t.instance.heapId!=heapBoxInst.instance.heapId&&heapBoxInst.instance.state&&(t._callbackManager("change","_closeOthers",!0),heapBoxInst._closeheap(!0,function(){},function(){t._callbackManager("change","_closeOthers",!1)})))}),t._callbackManager("test","_closeOthers")},_callbackManager:function(e,t,s){this.callbackManager[t]||(this.callbackManager[t]=0),"change"==e?(s?this.callbackManager[t]++:this.callbackManager[t]--,this._callbackManager("test",t)):"test"==e&&0==this.callbackManager[t]&&this._handlerClicked(!0)},set:function(e){this._setData(e),this._setHolderTitle(),this._setEvents()},select:function(t){heapBoxEl=e("div#heapbox_"+this.instance.heapId),this._heapChanged(this,heapBoxEl.find('.heapOptions [rel="'+t+'"]'))},update:function(){this._setDefaultValues()},_hideSourceElement:function(){this.elem_isVisible=e(this.element).is(":visible"),e(this.element).css("display","none")},_showSourceElement:function(){e(this.element).css("display","block")},hide:function(){e("div#heapbox_"+this.instance.heapId).css("visibility","hidden")},show:function(){e("div#heapbox_"+this.instance.heapId).css("visibility","visible")},disable:function(){return heapBoxEl=e("div#heapbox_"+this.instance.heapId),heapBoxEl.addClass("disabled"),this._removeHeapboxHandlerEvents(),this._removeHeapboxHolderEvents(),this},enable:function(){return heapBoxEl=e("div#heapbox_"+this.instance.heapId),heapBoxEl.removeClass("disabled"),this._setEvents(),this},_remove:function(){heapBoxEl=e("div#heapbox_"+this.instance.heapId),heapBoxEl.remove(),this._showSourceElement()},_reset:function(){console.log("_reset"),heapBoxEl=e("div#heapbox_"+this.instance.heapId),heapBoxEl.parent().removeClass("changed");var t=e("ul.heapOptions li:first-child a",heapBoxEl);e("a.holder",heapBoxEl).attr("rel",0).attr("data-user-selected",0).text(t.text()),e("ul.heapOptions li a",heapBoxEl).removeClass("selected"),t.addClass("selected")}},e.fn[a]=function(t,s){return this.each(function(){if(e.data(this,"plugin_"+a))switch(heapBoxInst=e.data(this,"plugin_"+a),t){case"select":heapBoxInst.select(s);break;case"update":heapBoxInst.update();break;case"set":heapBoxInst.set(s);break;case"hide":heapBoxInst.hide();break;case"show":heapBoxInst.show();break;case"disable":heapBoxInst.disable();break;case"enable":heapBoxInst.enable();break;case"remove":heapBoxInst._remove();break;case"reset":heapBoxInst._reset()}else e.data(this,"plugin_"+a,new n(this,t))})}}(jQuery,window,document);